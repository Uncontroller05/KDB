<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Bag | Kapda Dekho</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fbf8f4;
      --surface:#ffffff;
      --surface-2:#f4efe8;
      --ink:#1f1f1f;
      --muted:#6c6c6c;
      --accent:#e76b6b;
      --border:#e7e1d9;
      --shadow:0 14px 40px rgba(28, 28, 28, 0.08);
      --success:#e8f7dc;
      --warning:#f6f2ff;
      --yellow:#f5c84c;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:'Montserrat',sans-serif;
      color:var(--ink);
      background:radial-gradient(circle at 10% 10%, #fff1e3 0%, transparent 55%),
                 radial-gradient(circle at 90% 20%, #e9f7f5 0%, transparent 50%),
                 var(--bg);
    }

    a{color:inherit;text-decoration:none}

    .announcement{
      background:linear-gradient(90deg, #f8d3c4, #f7e8c6, #dff2ee);
      color:#2f2f2f;
      text-align:center;
      padding:10px 16px;
      font-size:13px;
      letter-spacing:0.6px;
      font-weight:600;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(251, 248, 244, 0.9);
      backdrop-filter:blur(8px);
      border-bottom:1px solid var(--border);
    }

    .nav-wrap{
      display:flex;
      align-items:center;
      gap:20px;
      padding:18px 40px;
    }

    .logo{
      font-family:'Playfair Display',serif;
      font-size:28px;
      font-weight:700;
      letter-spacing:1px;
    }

    .nav-center{
      display:flex;
      gap:28px;
      font-weight:600;
      font-size:14px;
      text-transform:uppercase;
      letter-spacing:1px;
    }

    .nav-center a{
      padding-bottom:4px;
      border-bottom:2px solid transparent;
    }

    .nav-center a:hover{border-color:var(--accent)}

    .nav-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:16px;
    }

    .search{
      position:relative;
      width:260px;
    }

    .search input{
      width:100%;
      border:1px solid var(--border);
      padding:10px 38px 10px 14px;
      border-radius:24px;
      background:#fff;
      font-size:14px;
    }

    .search span{
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      font-size:16px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }

    .icon-btn{
      width:36px;
      height:36px;
      border-radius:50%;
      display:grid;
      place-items:center;
      background:var(--surface);
      border:1px solid var(--border);
      cursor:pointer;
      position:relative;
    }

    .wishlist-dot{
      position:absolute;
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--accent);
      top:6px;
      right:6px;
      display:none;
    }

    .account-wrap{position:relative}

    .account-menu{
      position:absolute;
      right:0;
      top:48px;
      width:220px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 12px 28px rgba(28, 28, 28, 0.12);
      padding:12px;
      display:none;
      z-index:30;
    }

    .account-menu.show{display:block}

    .menu-greet{font-style:italic;margin-bottom:8px}
    .menu-sep{height:1px;background:var(--border);margin:8px 0}

    .menu-link,
    .menu-btn{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-radius:10px;
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:14px;
      text-align:left;
    }

    .menu-link:hover,
    .menu-btn:hover{background:var(--surface-2)}

    .menu-muted{color:var(--muted)}

    .page{
      padding:24px 40px 60px;
    }

    .page-title{
      font-family:'Playfair Display',serif;
      font-size:28px;
      margin-bottom:8px;
    }

    .layout{
      display:grid;
      grid-template-columns:1.1fr 0.8fr;
      gap:24px;
    }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:0 8px 24px rgba(28, 28, 28, 0.06);
    }

    .save-banner{
      background:var(--success);
      border:1px solid #b7ddb1;
      border-radius:12px;
      padding:12px 14px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
    }

    .bag-list{
      display:grid;
      gap:12px;
    }

    .bag-item{
      display:grid;
      grid-template-columns:88px 1fr auto;
      gap:14px;
      align-items:center;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }

    .bag-item img{
      width:88px;
      height:88px;
      object-fit:cover;
      border-radius:12px;
      background:#111;
    }

    .bag-item h4{font-size:15px;margin-bottom:6px}
    .bag-item small{color:var(--muted)}

    .qty{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:6px;
    }

    .qty button{
      width:26px;
      height:26px;
      border-radius:50%;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
    }

    .remove-btn{
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      font-size:12px;
    }

    .side-box{
      display:grid;
      gap:12px;
    }

    .coupon{
      background:var(--warning);
      border:1px solid #d6c5ff;
      border-radius:12px;
      padding:12px;
      display:grid;
      gap:8px;
    }

    .coupon input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
    }

    .coupon .apply-btn{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
    }

    .coupon .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .summary{
      display:grid;
      gap:10px;
    }

    .summary .row{
      display:flex;
      justify-content:space-between;
      font-size:14px;
    }

    .summary .free{
      background:var(--success);
      border-radius:10px;
      padding:8px;
      text-align:center;
      font-weight:600;
      color:#2a6b2a;
    }

    .pay-btn{
      padding:14px;
      border-radius:14px;
      border:none;
      background:var(--yellow);
      font-weight:700;
      cursor:pointer;
    }

    .address-form{
      display:grid;
      gap:8px;
      margin-top:10px;
    }

    .address-form input{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      font-size:14px;
      background:#fff;
    }

    .address-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    .address-btn{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
    }

    .address-status{
      font-size:12px;
      color:var(--muted);
    }

    .empty{
      padding:20px;
      border:1px dashed var(--border);
      border-radius:16px;
      color:var(--muted);
      text-align:center;
      background:var(--surface);
    }

    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .search{display:none}
    }

    @media (max-width: 640px){
      .nav-wrap{flex-wrap:wrap;gap:12px}
      .nav-center{flex-wrap:wrap;gap:14px}
      .page{padding:20px}
      .bag-item{grid-template-columns:64px 1fr auto}
      .bag-item img{width:64px;height:64px}
    }
  </style>
</head>
<body>
  <div class="announcement">FREE SHIPPING ABOVE Rs 399 · EASY RETURNS · NEW ARRIVALS DAILY</div>

  <header>
    <div class="nav-wrap">
      <a class="logo" href="index.html">KAPDA DEKHO</a>
      <nav class="nav-center">
        <a href="men-clothing.html">Men</a>
        <a href="women-clothing.html">Women</a>
      </nav>
      <div class="nav-right">
        <div class="search">
          <input type="text" placeholder="Search bag" />
          <span>&#128269;</span>
        </div>
        <a class="icon-btn" href="wishlist.html" aria-label="Wishlist" title="Wishlist">
          &#9825;
          <span class="wishlist-dot" id="wishlist-dot"></span>
        </a>
        <a class="icon-btn" href="order-history.html" aria-label="Orders" title="Orders">&#128722;</a>
        <div class="account-wrap">
          <button class="icon-btn" id="account-btn" aria-label="Account">&#128100;</button>
          <div class="account-menu" id="account-menu" aria-hidden="true">
            <div class="menu-greet" id="menu-greet">Hi</div>
            <div class="menu-sep"></div>
            <div id="menu-auth">
              <button class="menu-btn" id="menu-login">Login</button>
              <button class="menu-btn" id="menu-signup">Sign Up</button>
              <div class="menu-sep"></div>
            </div>
            <a class="menu-link" href="index.html">My Account</a>
            <a class="menu-link" href="wishlist.html">My Wishlist</a>
            <a class="menu-link" href="order-history.html">My Orders</a>
            <a class="menu-link" href="bag.html">My Bag</a>
            <div class="menu-sep"></div>
            <button class="menu-btn" id="menu-logout">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="page">
    <h1 class="page-title" id="bag-title">My Bag (0 Items)</h1>
    <div class="layout">
      <section>
        <div class="save-banner">You are saving ₹480 on this order</div>
        <div class="bag-list" id="bag-list"></div>
      </section>
      <aside class="side-box">
        <div class="card" id="address-card">
          <div class="row" style="display:flex;justify-content:space-between;align-items:center;">
            <div>Deliver to: <strong id="deliver-to">Not set</strong></div>
            <button class="address-btn" id="change-address">Change</button>
          </div>
          <div class="address-status" id="address-status">Add a delivery address to proceed.</div>
          <div class="address-form" id="address-form" style="display:none;">
            <input type="text" id="addr-name" placeholder="Full name" />
            <input type="text" id="addr-phone" placeholder="Phone number" />
            <input type="text" id="addr-line" placeholder="Address (House/Street/Area)" />
            <input type="text" id="addr-city" placeholder="City" />
            <input type="text" id="addr-state" placeholder="State" />
            <input type="text" id="addr-pin" placeholder="Pincode (6 digits)" />
            <div class="address-actions">
              <button class="address-btn" id="save-address">Save</button>
              <button class="address-btn" id="cancel-address">Cancel</button>
            </div>
          </div>
        </div>
        <div class="coupon" id="coupon-box">
          <div class="row">
            <strong>Apply Coupon</strong>
            <span style="font-size:12px;">🎉</span>
          </div>
          <div class="row" style="gap:8px;">
            <input type="text" id="coupon-input" placeholder="Enter coupon code" />
            <button class="apply-btn" id="apply-coupon">Apply</button>
          </div>
          <div class="row">
            <small id="coupon-msg" style="color:#6b46c1;"></small>
            <button class="apply-btn" id="remove-coupon" style="display:none;">Remove</button>
          </div>
        </div>
        <div class="card summary">
          <div class="row"><span>Price Summary</span><span></span></div>
          <div class="row"><span>Subtotal</span><strong id="bag-subtotal">Rs 0</strong></div>
          <div class="row"><span>Discount</span><strong id="bag-discount">Rs 0</strong></div>
          <div class="row"><span>Delivery</span><strong id="bag-delivery">Rs 0</strong></div>
          <div class="row"><span>Total</span><strong id="bag-total">Rs 0</strong></div>
          <div class="free" id="delivery-note">Free delivery on orders above Rs 799</div>
          <button class="pay-btn" id="pay-btn">PROCEED</button>
        </div>
      </aside>
    </div>
  </main>

  <div class="modal" id="account-modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">Account</div>
        <button class="close-btn" id="close-modal" aria-label="Close">×</button>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="login">Login</button>
        <button class="tab" data-tab="signup">Sign Up</button>
      </div>
      <form class="form" id="login-form">
        <div>
          <label>Email</label>
          <input type="email" id="login-email" required />
        </div>
        <div>
          <label>Password</label>
          <input type="password" id="login-password" required />
        </div>
        <button type="submit">Login</button>
        <button type="button" class="google-btn" id="google-login">Continue with Google</button>
        <div class="helper">Demo only. No real authentication.</div>
      </form>
      <form class="form" id="signup-form" style="display:none;">
        <div>
          <label>Name</label>
          <input type="text" id="signup-name" required />
        </div>
        <div>
          <label>Email</label>
          <input type="email" id="signup-email" required />
        </div>
        <div>
          <label>Password</label>
          <input type="password" id="signup-password" required />
        </div>
        <button type="submit">Create Account</button>
        <button type="button" class="google-btn" id="google-signup">Continue with Google</button>
        <div class="helper">Demo only. No real authentication.</div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000';
    const WISHLIST_KEY = 'kd_wishlist';
    const BAG_KEY = 'kd_bag';
    const COUPON_KEY = 'kd_coupon';
    const list = document.getElementById('bag-list');
    const subtotalEl = document.getElementById('bag-subtotal');
    const discountEl = document.getElementById('bag-discount');
    const deliveryEl = document.getElementById('bag-delivery');
    const totalEl = document.getElementById('bag-total');
    const titleEl = document.getElementById('bag-title');
    const payBtn = document.getElementById('pay-btn');
    const dot = document.getElementById('wishlist-dot');
    const deliveryNote = document.getElementById('delivery-note');
    const couponInput = document.getElementById('coupon-input');
    const applyCouponBtn = document.getElementById('apply-coupon');
    const removeCouponBtn = document.getElementById('remove-coupon');
    const couponMsg = document.getElementById('coupon-msg');

    const deliverTo = document.getElementById('deliver-to');
    const changeAddress = document.getElementById('change-address');
    const addressForm = document.getElementById('address-form');
    const saveAddressBtn = document.getElementById('save-address');
    const cancelAddressBtn = document.getElementById('cancel-address');
    const addressStatus = document.getElementById('address-status');

    const addrName = document.getElementById('addr-name');
    const addrPhone = document.getElementById('addr-phone');
    const addrLine = document.getElementById('addr-line');
    const addrCity = document.getElementById('addr-city');
    const addrState = document.getElementById('addr-state');
    const addrPin = document.getElementById('addr-pin');

    const accountBtn = document.getElementById('account-btn');
    const accountMenu = document.getElementById('account-menu');
    const menuGreet = document.getElementById('menu-greet');
    const menuAuth = document.getElementById('menu-auth');
    const menuLogin = document.getElementById('menu-login');
    const menuSignup = document.getElementById('menu-signup');
    const menuLogout = document.getElementById('menu-logout');

    const accountModal = document.getElementById('account-modal');
    const closeModal = document.getElementById('close-modal');
    const tabs = document.querySelectorAll('.tab');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');

    let currentUser = null;

    function refreshDot(){
      const items = JSON.parse(localStorage.getItem(WISHLIST_KEY) || '[]');
      dot.style.display = items.length ? 'block' : 'none';
    }

    function getBag(){
      return JSON.parse(localStorage.getItem(BAG_KEY) || '[]');
    }

    function saveBag(items){
      localStorage.setItem(BAG_KEY, JSON.stringify(items));
    }

    function calcTotal(items){
      return items.reduce((sum, i) => {
        const num = parseInt((i.price || '0').replace(/[^0-9]/g,''), 10) || 0;
        return sum + num * (i.qty || 1);
      }, 0);
    }

    function getCoupon(){
      return JSON.parse(localStorage.getItem(COUPON_KEY) || 'null');
    }

    function saveCoupon(coupon){
      if(coupon){
        localStorage.setItem(COUPON_KEY, JSON.stringify(coupon));
      }else{
        localStorage.removeItem(COUPON_KEY);
      }
    }

    function calculateDiscount(subtotal, coupon){
      if(!coupon) return 0;
      if(coupon.code === 'SAVE10'){
        return Math.floor(subtotal * 0.10);
      }
      if(coupon.code === 'GETCASH10'){
        return 202;
      }
      return 0;
    }

    function render(){
      const items = getBag();
      list.innerHTML = '';
      titleEl.textContent = `My Bag (${items.length} Items)`;
      if(!items.length){
        list.innerHTML = '<div class="empty">Your bag is empty.</div>';
        subtotalEl.textContent = 'Rs 0';
        discountEl.textContent = 'Rs 0';
        totalEl.textContent = 'Rs 0';
        return;
      }
      items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'bag-item';
        row.innerHTML = `
          ${item.img ? `<img src="${item.img}" alt="${item.name}">` : `<div style="width:88px;height:88px;border-radius:12px;background:#111;display:grid;place-items:center;color:#fff;font-size:10px;">TEE</div>`}
          <div>
            <h4>${item.name}</h4>
            <small>${item.price}</small>
            <div class="qty">
              <button data-action="dec" data-id="${item.id}">-</button>
              <span>${item.qty}</span>
              <button data-action="inc" data-id="${item.id}">+</button>
            </div>
          </div>
          <button class="remove-btn" data-remove="${item.id}">Remove</button>
        `;
        list.appendChild(row);
      });

      const subtotal = calcTotal(items);
      const coupon = getCoupon();
      const discount = calculateDiscount(subtotal, coupon);
      const afterDiscount = Math.max(0, subtotal - discount);
      const deliveryFee = afterDiscount >= 799 ? 0 : 49;
      const total = afterDiscount + deliveryFee;
      subtotalEl.textContent = `Rs ${subtotal}`;
      discountEl.textContent = `Rs ${discount}`;
      deliveryEl.textContent = `Rs ${deliveryFee}`;
      totalEl.textContent = `Rs ${total}`;
      deliveryNote.textContent = afterDiscount >= 799
        ? 'Yay! You get FREE delivery on this order'
        : 'Free delivery on orders above Rs 799';

      list.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', () => {
          const items = getBag();
          const item = items.find(i => i.id === btn.dataset.id);
          if(!item) return;
          if(btn.dataset.action === 'inc') item.qty += 1;
          if(btn.dataset.action === 'dec') item.qty = Math.max(1, item.qty - 1);
          saveBag(items);
          render();
        });
      });

      list.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', () => {
          const items = getBag().filter(i => i.id !== btn.dataset.remove);
          saveBag(items);
          render();
        });
      });
    }

    function setupSearch(){
      const input = document.querySelector('.search input');
      if(!input) return;
      const icon = document.querySelector('.search span');
      if(icon){
        icon.addEventListener('click', () => input.focus());
      }
      input.addEventListener('input', () => {
        const q = input.value.trim().toLowerCase();
        document.querySelectorAll('.bag-item').forEach(item => {
          const title = item.querySelector('h4');
          const text = title ? title.textContent.toLowerCase() : '';
          item.style.display = !q || text.includes(q) ? '' : 'none';
        });
      });
    }

    async function api(path, options){
      const res = await fetch(`${API_BASE}${path}`, {
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        ...options
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        throw new Error(data.error || 'Request failed');
      }
      return data;
    }

    function openModal(){
      accountModal.classList.add('show');
      accountModal.setAttribute('aria-hidden', 'false');
    }

    function closeModalFn(){
      accountModal.classList.remove('show');
      accountModal.setAttribute('aria-hidden', 'true');
    }

    function toggleMenu(force){
      const show = typeof force === 'boolean' ? force : !accountMenu.classList.contains('show');
      accountMenu.classList.toggle('show', show);
      accountMenu.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    function setTab(name){
      tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === name));
      loginForm.style.display = name === 'login' ? 'grid' : 'none';
      signupForm.style.display = name === 'signup' ? 'grid' : 'none';
    }

    function setAccountUI(user){
      currentUser = user || null;
      if(currentUser){
        menuGreet.textContent = `Hi, ${currentUser.name || 'User'}`;
        menuAuth.style.display = 'none';
        menuLogout.style.display = 'flex';
      }else{
        menuGreet.textContent = 'Hi';
        menuAuth.style.display = 'block';
        menuLogout.style.display = 'none';
      }
    }

    function getAddressKey(){
      if(currentUser && currentUser.email){
        return `kd_address_${currentUser.email}`;
      }
      return 'kd_address_guest';
    }

    function loadAddress(){
      return JSON.parse(localStorage.getItem(getAddressKey()) || 'null');
    }

    function saveAddress(data){
      localStorage.setItem(getAddressKey(), JSON.stringify(data));
    }

    function renderAddress(){
      const addr = loadAddress();
      if(addr && addr.pincode){
        deliverTo.textContent = addr.pincode;
        addressStatus.textContent = `${addr.name}, ${addr.line}, ${addr.city}, ${addr.state} - ${addr.pincode}`;
      }else{
        deliverTo.textContent = 'Not set';
        addressStatus.textContent = 'Add a delivery address to proceed.';
      }
    }

    accountBtn.addEventListener('click', () => toggleMenu());

    document.addEventListener('click', (e) => {
      if(!accountMenu.contains(e.target) && !accountBtn.contains(e.target)){
        toggleMenu(false);
      }
    });

    closeModal.addEventListener('click', closeModalFn);
    accountModal.addEventListener('click', (e) => {
      if(e.target === accountModal) closeModalFn();
    });

    tabs.forEach(tab => tab.addEventListener('click', () => setTab(tab.dataset.tab)));

    menuLogin.addEventListener('click', () => {
      toggleMenu(false);
      setTab('login');
      openModal();
    });

    menuSignup.addEventListener('click', () => {
      toggleMenu(false);
      setTab('signup');
      openModal();
    });

    menuLogout.addEventListener('click', async () => {
      try{
        await api('/api/logout', { method: 'POST' });
        setAccountUI(null);
        toggleMenu(false);
      }catch(e){
        alert(e.message);
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      try{
        const data = await api('/api/login', {
          method: 'POST',
          body: JSON.stringify({ email, password })
        });
        setAccountUI(data.user);
        closeModalFn();
        renderAddress();
      }catch(err){
        alert(err.message);
      }
    });

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('signup-name').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value.trim();
      try{
        const data = await api('/api/signup', {
          method: 'POST',
          body: JSON.stringify({ name, email, password })
        });
        setAccountUI(data.user);
        closeModalFn();
        renderAddress();
      }catch(err){
        alert(err.message);
      }
    });

    document.getElementById('google-login').addEventListener('click', () => {
      alert('Google sign-in is not configured in this demo backend.');
    });

    document.getElementById('google-signup').addEventListener('click', () => {
      alert('Google sign-in is not configured in this demo backend.');
    });

    changeAddress.addEventListener('click', () => {
      const addr = loadAddress();
      if(addr){
        addrName.value = addr.name || '';
        addrPhone.value = addr.phone || '';
        addrLine.value = addr.line || '';
        addrCity.value = addr.city || '';
        addrState.value = addr.state || '';
        addrPin.value = addr.pincode || '';
      }
      addressForm.style.display = 'grid';
    });

    cancelAddressBtn.addEventListener('click', () => {
      addressForm.style.display = 'none';
    });

    saveAddressBtn.addEventListener('click', () => {
      const data = {
        name: addrName.value.trim(),
        phone: addrPhone.value.trim(),
        line: addrLine.value.trim(),
        city: addrCity.value.trim(),
        state: addrState.value.trim(),
        pincode: addrPin.value.trim()
      };
      if(!data.name || !data.phone || !data.line || !data.city || !data.state || !/^\d{6}$/.test(data.pincode)){
        alert('Please fill all fields and a valid 6-digit pincode.');
        return;
      }
      saveAddress(data);
      addressForm.style.display = 'none';
      renderAddress();
    });

    applyCouponBtn.addEventListener('click', () => {
      const code = couponInput.value.trim().toUpperCase();
      if(code !== 'SAVE10' && code !== 'GETCASH10'){
        couponMsg.textContent = 'Invalid coupon code.';
        couponMsg.style.color = '#b91c1c';
        return;
      }
      saveCoupon({ code });
      couponMsg.textContent = `${code} applied successfully.`;
      couponMsg.style.color = '#2a6b2a';
      removeCouponBtn.style.display = 'inline-block';
      render();
    });

    removeCouponBtn.addEventListener('click', () => {
      saveCoupon(null);
      couponInput.value = '';
      couponMsg.textContent = '';
      couponMsg.style.color = '#6b46c1';
      removeCouponBtn.style.display = 'none';
      render();
    });

    const existing = getCoupon();
    if(existing){
      couponInput.value = existing.code;
      couponMsg.textContent = `${existing.code} applied successfully.`;
      couponMsg.style.color = '#2a6b2a';
      removeCouponBtn.style.display = 'inline-block';
    }

    payBtn.addEventListener('click', async () => {
      const items = getBag();
      if(!items.length){
        alert('Bag is empty.');
        return;
      }
      const addr = loadAddress();
      if(!addr || !/^\d{6}$/.test(addr.pincode || '')){
        alert('Please add a valid 6-digit pincode address before placing the order.');
        return;
      }
      try{
        const me = await api('/api/me');
        currentUser = me.user;
      }catch{
        alert('Please login to place an order.');
        return;
      }

      try{
        await api('/api/orders', {
          method: 'POST',
          body: JSON.stringify({ items })
        });
        saveBag([]);
        render();
        window.location.href = 'order-history.html';
      }catch(err){
        alert(err.message);
      }
    });

    refreshDot();
    render();
    setupSearch();
    api('/api/me').then(data => {
      setAccountUI(data.user);
      renderAddress();
    }).catch(() => {
      setAccountUI(null);
      renderAddress();
    });
  </script>
</body>
</html>
